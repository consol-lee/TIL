# 2023-03-09

Ciliumì˜ Hubble ì„¤ì¹˜ ì‹œ gRPC í†µì‹ ì´ ì•ˆëœë‹¤ê³  ì•ˆë¨
ë‹¤ì‹œ ì„¤ì¹˜ ì§„í–‰

- kubernetes 1.22 í™˜ê²½ ì›Œì»¤ë…¸ë“œ 3ëŒ€
- cilium 1.10 ë²„ì „

ê´€ë ¨ URL
- https://docs.cilium.io/en/v1.10/gettingstarted/hubble_setup/


(1) cilium ìœ¼ë¡œ ì„¤ì¹˜í•˜ê¸° -> helm ìœ¼ë¡œ ì„¤ì¹˜í•œê²Œ ì•„ë‹ˆì–´ì„œ secret ì—ëŸ¬ë‚¨ ã… ã… 
- ê´€ë ¨ ì´ìŠˆ : https://github.com/cilium/cilium-cli/issues/959
```
$ cilium hubble enable
âš ï¸  Error parsing helm cli secret: unable to retrieve helm values secret kube-system/cilium-cli-helm-values: secrets "cilium-cli-helm-values" not found
âš ï¸  Proceeding in unknown installation state
ğŸ”® Auto-detected cilium version v1.10.16
ğŸ”‘ Created CA in secret cilium-ca
â„¹ï¸  helm template --namespace kube-system cilium cilium/cilium --version 1.10.16 --set hubble.enabled=true,hubble.relay.enabled=true,hubble.tls.ca.cert=LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNGRENDQWJxZ0F3SUJBZ0lVQlhoYWlsd3VIWkNCOTYvSDNzbk5EMS9IWHZJd0NnWUlLb1pJemowRUF3SXcKYURFTE1Ba0dBMVVFQmhNQ1ZWTXhGakFVQmdOVkJBZ1REVk5oYmlCR2NtRnVZMmx6WTI4eEN6QUpCZ05WQkFjVApBa05CTVE4d0RRWURWUVFLRXdaRGFXeHBkVzB4RHpBTkJnTlZCQXNUQmtOcGJHbDFiVEVTTUJBR0ExVUVBeE1KClEybHNhWFZ0SUVOQk1CNFhEVEl6TURNd09UQXlNalF3TUZvWERUSTRNRE13TnpBeU1qUXdNRm93YURFTE1Ba0cKQTFVRUJoTUNWVk14RmpBVUJnTlZCQWdURFZOaGJpQkdjbUZ1WTJselkyOHhDekFKQmdOVkJBY1RBa05CTVE4dwpEUVlEVlFRS0V3WkRhV3hwZFcweER6QU5CZ05WQkFzVEJrTnBiR2wxYlRFU01CQUdBMVVFQXhNSlEybHNhWFZ0CklFTkJNRmt3RXdZSEtvWkl6ajBDQVFZSUtvWkl6ajBEQVFjRFFnQUVNVk5XbGtXaTNQMGRQR2NXbElLejF3SEcKOXB2TjN4Z0hEZXFuRFhDWnNCdGJodzJmalZHZk5mY1EvRVk4bzdoMStOQmJXTGc1a21xQ0N6MGoyN3dNS3FOQwpNRUF3RGdZRFZSMFBBUUgvQkFRREFnRUdNQThHQTFVZEV3RUIvd1FGTUFNQkFmOHdIUVlEVlIwT0JCWUVGQlZ2Cmo5OE9nNlU2MkRHNFBkS0FzcUhDWWlOVE1Bb0dDQ3FHU000OUJBTUNBMGdBTUVVQ0lRQ3czc1dJQXNFMSt4RlcKTThHeUp3SnpJeFRHRmpTSDhSL3kxa2VITmd1eVd3SWdEY0ZmenRaZU1kRGRTOTB6MGp3ajFyVXBZRzNGNThiOQpUM0VFdVZXMVIyTT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=,hubble.tls.ca.key=[--- REDACTED WHEN PRINTING TO TERMINAL (USE --redact-helm-certificate-keys=false TO PRINT) ---]
âœ¨ Patching ConfigMap cilium-config to enable Hubble...
ğŸš€ Creating ConfigMap for Cilium version 1.10.16...
â™»ï¸  Restarted Cilium pods
âŒ› Waiting for Cilium to become ready before deploying other Hubble component(s)...
```

(ë²ˆì™¸) ì¼ë‹¨ hubble ì„¤ì¹˜
```
$ export HUBBLE_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/hubble/master/stable.txt)
$ curl -L --remote-name-all https://github.com/cilium/hubble/releases/download/$HUBBLE_VERSION/hubble-linux-amd64.tar.gz{,.sha256sum}
$ sha256sum --check hubble-linux-amd64.tar.gz.sha256sum
$ sudo tar xzvfC hubble-linux-amd64.tar.gz /usr/local/bin
$ rm hubble-linux-amd64.tar.gz{,.sha256sum}
```

(2) apply ë¡œ ì„¤ì¹˜ (ì„±ê³µ-> í•œ í´ëŸ¬ìŠ¤í„°ì—ì„œë§Œ..)
```
$ kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/v1.9/install/kubernetes/quick-install.yaml
$ kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/v1.9/install/kubernetes/quick-hubble-install.yaml
```

ë¡œê·¸ ë³´ë©´
```
level=info msg=Connecting address="192.168.129.8:4244" hubble-tls=true peer=nks-7403-m-2eew subsys=hubble-relay
level=warning msg="Failed to create gRPC client" address="192.168.129.6:4244" error="connection error: desc = \"transport: error while dialing: dial tcp 192.168.129.6:4244: connect: connection refused\"" hubble-tls=true next-try-in=1h30m0s peer=nks-7403-m-2eeu subsys=hubble-relay
level=info msg=Connecting address="192.168.129.6:4244" hubble-tls=true peer=nks-7403-m-2eeu subsys=hubble-relay
level=warning msg="Failed to create gRPC client" address="192.168.129.7:4244" error="connection error: desc = \"transport: error while dialing: dial tcp 192.168.129.7:4244: connect: connection refused\"" hubble-tls=true next-try-in=1h30m0s peer=nks-7403-m-2eev subsys=hubble-relay
level=info msg=Connecting address="192.168.129.7:4244" hubble-tls=true peer=nks-7403-m-2eev subsys=hubble-relay
level=warning msg="Failed to create gRPC client" address="192.168.129.8:4244" error="connection error: desc = \"transport: error while dialing: dial tcp 192.168.129.8:4244: connect: connection refused\"" hubble-tls=true next-try-in=1h30m0s peer=nks-7403-m-2eew subsys=hubble-relay
level=warning msg="Failed to create gRPC client" address="192.168.129.6:4244" error="connection error: desc = \"transport: error while dialing: dial tcp 192.168.129.6:4244: connect: connection refused\"" hubble-tls=true next-try-in=1h30m0s peer=nks-7403-m-2eeu subsys=hubble-relay
level=warning msg="Failed to create gRPC client" address="192.168.129.7:4244" error="connection error: desc = \"transport: error while dialing: dial tcp 192.168.129.7:4244: connect: connection refused\"" hubble-tls=true next-try-in=1h30m0s peer=nks-7403-m-2eev subsys=hubble-relay
level=info msg=Connecting address="192.168.129.10:4244" hubble-tls=true peer=node-1-w-2h65 subsys=hubble-relay
level=info msg=Connecting address="192.168.129.11:4244" hubble-tls=true peer=node-1-w-2h66 subsys=hubble-relay
level=info msg=Connecting address="192.168.129.9:4244" hubble-tls=true peer=node-1-w-2eex subsys=hubble-relay
level=info msg=Connected address="192.168.129.10:4244" hubble-tls=true peer=node-1-w-2h65 subsys=hubble-relay
level=info msg=Connected address="192.168.129.11:4244" hubble-tls=true peer=node-1-w-2h66 subsys=hubble-relay
level=info msg=Connected address="192.168.129.9:4244" hubble-tls=true peer=node-1-w-2eex subsys=hubble-relay
```

ë¦´ë ˆì´ê°€ ì„±ê³µí•˜ëŠ” ì• ê°€ ìˆê³  ì•„ë‹Œ ì• ê°€ ìˆëŠ”ë° ë³´ë©´ ë§ˆìŠ¤í„°ì„ ã…¡ã…¡ã…‹

(ë²ˆì™¸) hubble ui í™•ì¸
```
while true; do cilium connectivity test; done
```


ì™œ ì•ˆëëƒ?
hubble-uiì˜ backend ë¡œê·¸ ì¤‘ ì´ëŸ° ì• ê°€ ìˆìŒ
```
level=error msg="fetching hubble flows: connecting to hubble-relay (attempt #17) failed: rpc error: code = Unavailable desc = connection error: desc = \"transport: Error while dialing dial tcp: lookup hubble-relay on 169.254.25.10:53: no such host\"\n" subsys=ui-backend
```

gma..
corednsì—ì„œ ë„£ì—ˆë˜ ì„¤ì • ë¹¼ë‹ˆê¹Œ ë¨ -> hosts ì´ê²Œ ë¬¸ì  ë°

```
apiVersion: v1
data:
  Corefile: |
    .:53 {
        errors
        health {
            lameduck 5s
        }
        ready
        hosts {
          ip archive.com
        }
        kubernetes cluster.local in-addr.arpa ip6.arpa {
          pods insecure
          fallthrough in-addr.arpa ip6.arpa
        }
        prometheus :9153
        forward . /etc/resolv.conf {
          prefer_udp
        }
        cache 30

        loop
        reload
        loadbalance
    }
kind: ConfigMap
metadata:
  labels:
    addonmanager.kubernetes.io/mode: EnsureExists
  name: coredns
  namespace: kube-system
```

ìª¼ë” ë” ìš°ì•„í•˜ê²Œ ë¡œê·¸ ë³´ê¸°
```
$ k logs -f -n kube-system --selector 'k8s-app=kube-dns'
```

---


- kubernetes crd
Custom Resource Definition (CRD)

kubernetesì—ì„œ ì§€ì›í•˜ëŠ” ë¦¬ì†ŒìŠ¤ ì´ì™¸ì˜ ìƒˆë¡œìš´ ë¦¬ì†ŒìŠ¤ë¥¼ ì •ì˜í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŒ

---

cilium cluster mesh ì„¤ì¹˜
-> https://docs.cilium.io/en/v1.9/gettingstarted/clustermesh/
```
Prerequisites
- PodCIDR ranges in all clusters must be non-conflicting.
```
ì „ì œ ì¡°ê±´ì— ê±¸ë¦¼
íŒŒë“œ ëŒ€ì—­ì€ ê²¹ì¹˜ë©´ ì•ˆë¨ ã… .ã…  ê·¸ë˜ì„œ ì•ˆë©ë‹ˆë‹¤~